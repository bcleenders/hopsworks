<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:pe="http://primefaces.org/ui/extensions"
      >
    <script type="text/javascript">
        function editLastDatatableRow(){

            jQuery('.ui-datatable-data tr').last().find('span.ui-icon-pencil').each(function(){
                jQuery(this).click()
            });
        }

    </script>
    <h:body>
        <ui:composition>
            <pe:tooltip global="true" showEvent="focus" myPosition="left center" atPosition="right center" />  
            <div id="createWizard" >

                <h:form id="mainForm">

                    <p:wizard widgetVar="wiz"
                              flowListener="#{clusterManagementController.onFlowProcess}" styleClass="wizard">

                        <p:tab id="clusterCommon" title="Common">
                            <p:messages id="msgs"/>
                            <p:panel header="Global Attributes" >
                                <h:panelGrid columns="2" columnClasses="label, value" styleClass="wizardElements">
                                    <h:outputText value="Cluster name: *" />
                                    <p:inputText required="true" label="Missing cluster name"
                                                 title="Enter a name for the cluster"
                                                 value="#{clusterManagementController.cluster.name}" >
                                    </p:inputText>

                                    <h:outputText value="Provider: *" />
                                    <p:selectOneMenu id="providers" label="Select a provider"
                                                     required="true"
                                                     value="#{clusterManagementController.cluster.provider.name}">
                                        <f:selectItem itemLabel="Select One" itemValue="" /> 
                                        <f:selectItems value="#{clusterManagementController.options.provider}" />
                                        <p:ajax listener="#{clusterManagementController.handleProviderChange}"
                                                event="change" update="instancesEC2 instanceRest" process="@form"/>
                                    </p:selectOneMenu>
                                    <h:outputText value="Environment: *" />
                                    <p:selectOneMenu id="environment" label="Select environment type"
                                                     required="true"
                                                     value="#{clusterManagementController.cluster.global.environment}">
                                        <f:selectItem itemLabel="Select One" itemValue="" /> 
                                        <f:selectItems value="#{clusterManagementController.options.environment}" />

                                    </p:selectOneMenu>
                                    <h:outputText value="Install Phase: "/>
                                    <p:selectBooleanCheckbox label="Jump?" value="#{clusterManagementController.cluster.installPhase}"/>

                                </h:panelGrid>
                            </p:panel>
                            <p:spacer height="25px"/>
                            <p:panel header="Git parameters (Optional)" collapsed="true" toggleable="true">
                                <h:panelGrid columns="2" columnClasses="label, value" styleClass="wizardElements">
                                    <h:outputText value="Git username: " />
                                    <p:inputText required="false" label="Missing git user"
                                                 title="Enter user name to access your git repository"
                                                 value="#{clusterManagementController.cluster.global.git.user}" />

                                    <h:outputText value="Git repository: " />
                                    <p:inputText required="false" label="Missing a git repository"
                                                 title="Enter url to clone your git repository"
                                                 value="#{clusterManagementController.cluster.global.git.repository}" />
                                    <h:outputText value="Git key: " />
                                    <p:inputTextarea required="false" label="Missing a key for the git repository"
                                                     title="Security key to clone your repository" rows ="10"
                                                     value="#{clusterManagementController.cluster.global.git.key}" />
                                </h:panelGrid>

                            </p:panel>

                            <p:spacer height="25px"/>

                            <p:panel header="Global Recipes" styleClass="wizard">
                                <h:panelGrid columns="2" columnClasses="value" styleClass="wizardElements">
                                    <p:dataTable id="recipeList" var="recipe" 
                                                 value="#{clusterManagementController.globalRecipes}"
                                                 rowKey="#{recipe}"
                                                 selection="#{clusterManagementController.selectedGlobalRecipes}"
                                                 selectionMode="multiple"
                                                 editable="true">

                                        <f:facet name="header">
                                            Click delete selection after selecting multiple instances to delete, use shift-click to select multiples
                                        </f:facet>
                                        <p:column headerText="Recipe">
                                            <p:cellEditor>
                                                <f:facet name="output">
                                                    <h:outputText value="#{recipe}" />
                                                </f:facet>
                                                <f:facet name="input">
                                                    <p:inputText value="#{recipe}" />
                                                </f:facet>
                                            </p:cellEditor>
                                        </p:column>
                                        <p:column headerText="Actions">
                                            <p:rowEditor />
                                        </p:column>
                                    </p:dataTable>
                                </h:panelGrid>

                                <p:commandButton id="addRecipeButton" value="New Recipe" 
                                                 icon="ui-icon-plusthick"
                                                 update=":recipeForm:addRecipe" 
                                                 process=":recipeForm:addRecipeDig"
                                                 oncomplete="addRecipeDialog.show()" 
                                                 />
                                <p:commandButton id="deleteRecipeButton" value="Delete Selection" 
                                                 process=":recipeForm:removeRecipeDig"
                                                 update=":recipeForm:deleteRecipe" 
                                                 oncomplete="removeRecipeDialog.show()" icon="ui-icon-minusthick" />
                            </p:panel>

                            <p:spacer height="25px"/>

                            <p:panel header="Global Ports" styleClass="wizard">
                                <h:panelGrid columns="2" columnClasses="label, value" styleClass="wizardElements">
                                    <p:dataTable id="portList" var="port" 
                                                 value="#{clusterManagementController.ports}"
                                                 rowKey="#{port}"
                                                 selection="#{clusterManagementController.selectedPorts}"
                                                 selectionMode="multiple"
                                                 editable="true">

                                        <f:facet name="header">
                                            Click delete selection after selecting multiple instances to delete, use shift-click to select multiples
                                        </f:facet>
                                        <p:column headerText="Port Number">
                                            <p:cellEditor>
                                                <f:facet name="output">
                                                    <h:outputText value="#{port}" />
                                                </f:facet>
                                                <f:facet name="input">
                                                    <p:inputText value="#{port}" />
                                                </f:facet>
                                            </p:cellEditor>
                                        </p:column>
                                        <p:column headerText="Actions">
                                            <p:rowEditor />
                                        </p:column>
                                    </p:dataTable>
                                </h:panelGrid>
                                <p:dialog header="Remove Port" widgetVar="removePortDialog" resizable="false"
                                          id="removePortDig"  
                                          showEffect="fade" hideEffect="explode" modal="true">  
                                    <h:outputText id="deletePort" value="Are you sure you want to delete?" />
                                    <p:commandButton  value="Confirm" update="portList" 
                                                      process="removePortDig"
                                                      action="#{clusterManagementController.removePorts}" 
                                                      oncomplete="editLastDataTableRow removePortDialog.close()"
                                                      />
                                </p:dialog>  
                                <p:dialog header="Add Port" widgetVar="addPortDialog" resizable="false"
                                          id="addPortDig"
                                          showEffect="fade" hideEffect="explode" modal="true">
                                    <h:outputText id="addPort" value="Port Number:" />
                                    <p:inputText id="portNumber" title="A port number in range 0 - 65535"
                                                 value="#{clusterManagementController.options.portNumber}"/>
                                    <p:commandButton id="acceptPort" value="Confirm" update="portList"
                                                     process="addPortDig"
                                                     action="#{clusterManagementController.addPort}"
                                                     oncomplete="editLastDataTableRow addPortDialog.close()"
                                                     />

                                </p:dialog>
                                <p:commandButton id="addPortButton" value="New Port" 
                                                 icon="ui-icon-plusthick"
                                                 update="mainForm:addPort" 
                                                 oncomplete="addPortDialog.show()" 
                                                 />
                                <p:commandButton id="deletePortButton" value="Delete Selection" 
                                                 update="mainForm:deletePort" 
                                                 oncomplete="removePortDialog.show()" icon="ui-icon-minusthick" />
                            </p:panel>

                        </p:tab>

                        <p:tab id="provider" title="Provider">
                            <p:panel header="Provider Details">

                                <p:messages id="providerMsgs"/>

                                <h:panelGrid columns="2" columnClasses="label, value" styleClass="wizardElements">


                                    <h:outputText value="Instance Type: *" />
                                    <p:selectOneMenu id="instancesEC2" label="Missing EC2instance type"
                                                     value="#{clusterManagementController.cluster.provider.instanceType}" 
                                                     rendered="#{clusterManagementController.renderEC2}"
                                                     required="#{clusterManagementController.renderEC2}">
                                        <f:selectItem itemLabel="Select One" itemValue="" /> 
                                        <f:selectItems value="#{clusterManagementController.options.ec2InstanceTypes}" />

                                    </p:selectOneMenu>
                                    <p:inputText id="instanceRest" title="Openstack instance type id number" label="Missing OpenStackInstanceID"
                                                 value="#{clusterManagementController.cluster.provider.instanceType}"
                                                 rendered="#{!clusterManagementController.renderEC2}"
                                                 required="#{!clusterManagementController.renderEC2}"/>

                                    <h:outputText value="Image: *" />
                                    <p:inputText  value="#{clusterManagementController.cluster.provider.image}" 
                                                  required="true" label="Missing Image ID"
                                                  title="Id of the image you want to use in OpenStack or in an EC2 Region"/>

                                    <h:outputText value="Override login user: *" 
                                                  rendered="true"/>
                                    <p:inputText value="#{clusterManagementController.cluster.provider.loginUser}" 
                                                 label="Missing login user"
                                                 title="User to log on the machines, required for OpenStack or custom AMI's in EC2"
                                                 required="#{!clusterManagementController.renderEC2}"/>

                                    <h:outputText value="Region: *" />
                                    <p:selectOneMenu id="regions" label="Select a EC2 Region"
                                                     value="#{clusterManagementController.cluster.provider.region}" 
                                                     rendered="#{clusterManagementController.renderEC2}" 
                                                     required="#{clusterManagementController.renderEC2}">
                                        <f:selectItem itemLabel="Select One" itemValue="" /> 
                                        <f:selectItems value="#{clusterManagementController.options.ec2Regions}" 
                                                       var="region"/>
<!--                                        <p:ajax listener="#{clusterManagementController.handleRegionChange}"
                                                event="change" update="zones" process="@this"/>-->

                                    </p:selectOneMenu>
                                    <p:inputText value="#{clusterManagementController.cluster.provider.region}" 
                                                 rendered="#{!clusterManagementController.renderEC2}"
                                                 label="OpenStack Region missing"
                                                 title="OpenStack region, usually it is the same name as the Project name"
                                                 required="#{!clusterManagementController.renderEC2}"/>
                                    <h:outputText value="Zones:" 
                                                  rendered="false"
                                                  />

                                    <p:selectManyCheckbox id="zones" 
                                                          value="#{clusterManagementController.cluster.provider.zones}" 
                                                          rendered="false">

                                        <f:selectItems value="#{clusterManagementController.zones}" />
                                    </p:selectManyCheckbox>
                                </h:panelGrid>

                            </p:panel>

                        </p:tab>

                        <p:tab id="nodeGroups" title="Groups">
                            <p:panel header="Cluster Nodes">
                                <h:panelGrid columns="3" columnClasses="label, value" styleClass="wizardElements">
                                    <p:dataTable id="groupList" var="group" 
                                                 value="#{clusterManagementController.groupsModel}"
                                                 rowKey="#{group.service}"
                                                 selection="#{clusterManagementController.selectedGroup}"
                                                 selectionMode="multiple"
                                                 editable="false">
                                        <f:facet name="header">
                                            Click delete selection after selecting multiple instances to delete, use shift-click to select multiples
                                        </f:facet>
                                        <p:column headerText="Service">
                                            <h:outputText value="#{group.service}" />
                                        </p:column>
                                        <p:column headerText="Number of Nodes">
                                            <h:outputText value="#{group.number}" />
                                        </p:column>
                                        <p:column headerText="Recipes">       
                                            <h:outputText value="#{group.recipes}"/>         
                                        </p:column>
                                        <p:column headerText="Ports">
                                            <h:outputText value="#{group.authorizePorts}"/>
                                        </p:column>
                                        <p:column headerText="Bittorrent">
                                            <h:outputText value="#{group.bittorrent}"/>
                                        </p:column>
                                        <p:column headerText="Chef Attributes">
                                            <h:outputText value="#{group.chefAttributes}"/>
                                        </p:column>
                                    </p:dataTable>
                                </h:panelGrid>

                                <p:commandButton id="addGroupButton" value="New Group" 
                                                 icon="ui-icon-plusthick"
                                                 update=":addGroupForm:addDig" 
                                                 oncomplete="addGroup.show()" 
                                                 />
                                <p:commandButton id="editButton" value="Edit selection"
                                                 update=":editGroupForm:editDig"
                                                 actionListener="#{clusterManagementController.editSelectedGroup}"
                                                 oncomplete="editGroup.show()"
                                                 />
                                <p:commandButton id="deleteButton" value="Delete Selection" 
                                                 update=":removeGroupForm:deletemsg" 
                                                 oncomplete="removeDialog.show()" icon="ui-icon-minusthick" />
                            </p:panel>

                        </p:tab>

                        <p:tab id="confirm" title="Confirmation">
                            <p:panel header="Confirmation">

                                <ui:include src="/sauron/template/clusterDescription.xhtml"/>



                            </p:panel>
                            <p:commandButton value="Submit" 
                                             actionListener="#{clusterManagementController.generateYAML}"
                                             action="proceedLaunchCluster"/>
                        </p:tab>

                    </p:wizard>

                </h:form>
                <ui:include src="/sauron/template/recipeForm.xhtml"/>
                <ui:include src="/sauron/template/removeGroupForm.xhtml"/>
                <ui:include src="/sauron/template/addGroupForm.xhtml"/>
                <ui:include src="/sauron/template/editGroupForm.xhtml"/>
            </div>
        </ui:composition>
    </h:body>
</html>

